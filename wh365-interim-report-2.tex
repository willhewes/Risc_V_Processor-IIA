\documentclass[a4paper,10pt]{article}
% Use ctrl + alt + V to view live pdf

% Packages
\usepackage[utf8]{inputenc} % For encoding
\usepackage[T1]{fontenc} % Better handling of accented characters and hyphenation
\usepackage{microtype} % Improves spacing and justification
\usepackage{amsmath, amssymb} % For equations and symbols
\usepackage{graphicx} % For including graphics/images
\usepackage{caption} % For customizing figure and table captions
\usepackage{subcaption} % For subfigures and subcaptions
\usepackage{float} % For fixing figure and table positions
\usepackage{booktabs} % For professional-looking tables
\usepackage{siunitx} % For consistent typesetting of units and numbers
\usepackage[margin=2cm]{geometry} % Adjusts page margins
\usepackage{fancyhdr} % For custom headers and footers
\usepackage{lmodern} % For a professional-looking font (main body font)
\usepackage{titlesec} % For title customization
\usepackage{array} % For custom table formatting
\usepackage[colorlinks=true, linkcolor=black, urlcolor=black]{hyperref} % Colored links without boxes
\usepackage{cleveref} % For improved cross-referencing    
\usepackage{multirow}
\usepackage{enumitem}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{textcomp}
\usepackage{tabularx}
\usepackage{changepage}
\usepackage{tikz}
\usepackage{pdfpages}
\usetikzlibrary{shapes.geometric, arrows}
\newcolumntype{Y}{>{\centering\arraybackslash}X}


\lstdefinestyle{vhdl-style}{
    language=VHDL,
    basicstyle=\ttfamily\footnotesize,
    keywordstyle=\bfseries\color{blue},
    commentstyle=\itshape\color{gray},
    stringstyle=\color{red},
    numbers=left,
    numberstyle=\tiny\color{gray},
    stepnumber=1,
    breaklines=true,
    showstringspaces=false,
    frame=single
}
\lstset{style=vhdl-style}
\lstset{captionpos=b}
\lstset{basicstyle=\ttfamily\scriptsize} 
\renewcommand{\lstlistingname}{Program}

% Custom settings
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\textit{GB3 - Risc-V Processor}} % Header left
\fancyhead[R]{\textit{Will Hewes - wh365}} % Header right 
\fancyfoot[C]{\thepage} % Footer center
\setlength{\headheight}{15pt} % Header height
\setlength{\parindent}{0em} % Indentation for paragraphs
\setlength{\parskip}{0.2em} % Add spacing between paragraphs
\setlength{\abovedisplayskip}{0.5em}
\setlength{\belowdisplayskip}{0.5em}
\setlength{\abovedisplayshortskip}{0.5em}
\setlength{\belowdisplayshortskip}{0.5em}
% \setlist{topsep=0em, partopsep=0em, itemsep=0em, parsep=0em}

\graphicspath{{Images/}}

% \renewcommand{\arraystretch}{1.2}

% Title formatting
\renewcommand{\maketitle}{
    \begin{center}
        \LARGE \textbf{ENGINEERING TRIPOS PART IIA} \\ 
        \vspace{0.5em}
        \Large \textbf{GB3 - Risc-V Processor} \\ 
        \vspace{0.5em}
        \textbf{Second Interim Report} \\
        \large Group 4 - Resource Usage \\
        \vspace{1em}
        \large Will Hewes - wh365 \\ 
        Pembroke College \\ 
        \vspace{0.5em}
    \end{center}
}

\begin{document}
%\includepdf[pages=-]{Handouts/IIA Project Coversheet Feedback Interim Report 2.pdf}
\maketitle
\hrule
\tableofcontents
\newpage

\section{Introduction}
\label{sec:Introduction}
% This section should give a detailed introduction to the changes
% you have implemented for your role on the team 
% (power/energy, time, or resource efficiency).

This project involves the collaborative design and implementation 
of a RISC-V processor on an iCE40 FPGA device. 
The overarching aim is to optimise 
the processor design with respect to its 
performance, power dissipation, and resource usage, 
while balancing trade-offs between these three aspects. 
Each team member is responsible for focusing on one of the three aspects.
My reports will focus on the resource usage of the design.

This report outlines the work carried out to reduce resource usage 
in the RISC-V processor implementation. 
My focus has been on optimising the Verilog modules 
most critical to logic utilisation, 
including the adder and program counter clock gating. 
The goal has been to reduce the number of LUTs and flip-flops consumed
by the processor while minimising 
excessive power dissipation or performance degredation.
These modifications form part of a broader group effort targeting performance, 
power consumption, and resource usage. 
Coordination has been ongoing to ensure our changes are compatible and 
contribute towards a coherent final design.

The analysis has primarily been concerning the
\texttt{bubblesort} program due to its increased complexity,
allowing the processor to be pushed further and 
offering more representative resource utilisation patterns.
Preliminary synthesis results indicated that the original design 
made no use of available DSP blocks, 
instead relying heavily on general-purpose LUTs for arithmetic operations.

\section{Preliminary Results}
\label{sec:Preliminary_Results}
% This section should provide detailed quantitative information and results so far
All tables provided will be in order of the changes that were made
and displayed in the Appendix, alongside relevant code snippets.
\subsection{Baseline}
\label{sec:Baseline}

Having performed the baseline analysis in the previous interim report,
the resource usage for the provided processor on the \texttt{bubblesort}
algorithm is shown in table \ref{tab:baseline} the Appendix.

In the baseline design, 
synthesis of the unmodified processor design showed that approximately 
58\% of the available logic cells on the iCE40 UP5K were in use,
along with two third of the available Block RAMs. 
This figure indicates limited headroom for 
further feature integration or pipeline complexity, 
motivating efforts to streamline key datapaths and control logic. 
In particular, duplication in ALU operations, bloated forwarding logic, 
and excess register usage were identified 
as contributors to excessive logic usage. 
Additionally, the design made no use of the available DSPs,
instead implementing its adder functions through LUTs.
These observations guided the subsequent design changes detailed in this report.

\subsection{Program Counter Clock Gating}
\label{sec:Program_Counter_Clock_Gating}

To reduce unnecessary switching activity in the control path, 
support for gated updates to the program counter was introduced. 
This involved modifying the program\_counter.v module 
to accept a write\_enable signal, 
allowing updates to be conditionally applied 
only when pipeline progression is required. 
The cpu.v module was updated accordingly to assert write\_enable 
whenever the stall signal is low, 
ensuring that the PC is held stable during pipeline stalls.

This change helps avoid logic toggling during idle or stalled cycles. 
This primarily has implications toward the power consumption, 
allowing the board to reduce unnecessary dynamic power dissipation 
caused by repeated switching in the program counter logic during pipeline stalls. 
The resource utilisation can be seen in 
table \ref{tab:Program_Counter} in the Appendix,
helping free up 9 logic cells.
Although the impact on LUT usage is minimal, 
this is part of a broader strategy to reduce switching 
by selectively enabling pipeline register updates â€” 
aligning with the power and resource optimisation goals of the project.

\subsection{alu.v}
\label{sec:alu.v}

The next module that was amended was the ALU. 
This is responsible for executing arithmetic, logical, 
and comparison operations, as directed by control signals 
generated in the decode stage and passed via the ALU Control module.

In the original design, separate adder structures were instantiated for 
ADD, SUB, and BEQ operations, leading to duplicated hardware logic. 
These were replaced with a unified DSP-optimised adder, controlled using the 
\texttt{is\_sub} and \texttt{b\_eff} signals. 
This enabled the synthesiser to map all arithmetic and 
branch comparison operations onto a single shared block, 
allowing DSP inference and freeing spare LUTs.

Additional simplifications included restructuring shift logic 
and centralising branch comparators to remove conditional duplication 
and streamline the datapath. 
The results of this change are shown in 
Table \ref{tab:ALU} in the Appendix, 
resulting in a further reduction of 14 logic cells. 
This represents a meaningful improvement in resource efficiency, 
with no measurable impact on performance.

\subsection{forwarding\_unit.v}
\label{sec:forwarding_unit.v}

\subsection{cpu.v \& pipeline\_registers.v}
\label{sec:cpu.v_and_pipeline_registers.v}

\section{Potential Risks}
\label{sec:Potential_Risks}
% This section should outline any challenges you ran into, 
% potential risks you see going into the final week, 
% and any steps you are taking to mitigate those risks.

\section{Future Work}
\label{sec:Future_Work}

\section{Conclusion}
\label{sec:Conclusion}

\newpage
\appendix
%Use this section to include diagrams, Verilog or C code, etc
\section{Resource Usage Data}

\begin{table}[H] 
    \centering
    \begin{tabularx}{0.6\textwidth}{X c c}
        \toprule
        Resource type & Used & \% of total \\ \midrule
        Logic cells (\texttt{ICESTORM\_LC}) & 3073 / 5280 & 58\,\% \\
        Block RAMs (\texttt{ICESTORM\_RAM}) & 20 / 30 & 66\,\% \\
        IO buffers (\texttt{SB\_IO}) & 8 / 96 & 8\,\% \\
        Global buffers (\texttt{SB\_GB}) & 5 / 8 & 62\,\% \\
        HF oscillators (\texttt{ICESTORM\_HFOSC}) & 1 / 1 & 100\,\% \\
        \bottomrule
    \end{tabularx}
    \caption{Baseline report}
    \label{tab:baseline}
\end{table}

\begin{table}[H] 
    \centering
    \begin{tabularx}{0.6\textwidth}{X c c}
        \toprule
        Resource type & Used & \% of total \\ \midrule
        Logic cells (\texttt{ICESTORM\_LC}) & 3066 / 5280 & 57\,\% \\
        Block RAMs (\texttt{ICESTORM\_RAM}) & 20 / 30 & 66\,\% \\
        IO buffers (\texttt{SB\_IO}) & 8 / 96 & 8\,\% \\
        Global buffers (\texttt{SB\_GB}) & 5 / 8 & 62\,\% \\
        HF oscillators (\texttt{ICESTORM\_HFOSC}) & 1 / 1 & 100\,\% \\
        \bottomrule
    \end{tabularx}
    \caption{Report after modifying the ALU Control module
    to eliminate duplicated logic functions}
    \label{tab:ALU_Control}
\end{table}

\begin{table}[H] 
    \centering
    \begin{tabularx}{0.6\textwidth}{X c c}
        \toprule
        Resource type & Used & \% of total \\ \midrule
        Logic cells (\texttt{ICESTORM\_LC}) & 3052 / 5280 & 57\,\% \\
        Block RAMs (\texttt{ICESTORM\_RAM}) & 20 / 30 & 66\,\% \\
        IO buffers (\texttt{SB\_IO}) & 8 / 96 & 8\,\% \\
        Global buffers (\texttt{SB\_GB}) & 5 / 8 & 62\,\% \\
        HF oscillators (\texttt{ICESTORM\_HFOSC}) & 1 / 1 & 100\,\% \\
        \bottomrule
    \end{tabularx}
    \caption{Report after modifying the ALU Control module
    to eliminate duplicated logic functions}
    \label{tab:ALU}
\end{table}

\section{Code}

%\section{Interim Report 1}
%\label{sec:{Interim_Report_1}}
%\includepdf[pages=3-]{Reports/wh365-interim-report-1.pdf}

\end{document}